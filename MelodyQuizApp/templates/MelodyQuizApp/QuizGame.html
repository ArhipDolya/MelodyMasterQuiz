{% extends 'base.html' %}

{% block title %}
    <title>QuizGame</title>
{% endblock %}

{% block content %}
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        Game Page
                    </div>
                    <div class="card-body">
                        {% if user.is_authenticated %}
                            {% if not user.socialaccount_set.all %}
                                <div id="timer" class="mt-3" style="margin-bottom: 10px;font-size:18px; font-weight:bold; color:#4CAF50;"></div>
                                <form id="guess-form">
                                    {% csrf_token %}

                                    <audio controls class="mb-3" id="song-preview">
                                        <source src="" type="audio/mpeg">
                                        Your browser does not support the audio element.
                                    </audio>
                                    <input type="text" class="form-control mb-3" id="song-guess" placeholder="Enter the song name">
                                    <button class="btn btn-primary" id="submit-answer">Submit Answer</button>
                                    <div id="result-message" class="mt-3 alert alert-info d-none" role="alert">
                                        <span id="result-message-text"></span>
                                    </div>
                                </form>
                                
                            {% endif %}
                        {% endif %}

                        {% if not user.is_authenticated %}
                            <h3 class="mb-3">
                                To get this functionality you firstly need to
                                <a href="{% url 'AccountsApp:register' %}" style='text-decoration:none'>Register</a>
                                or <a href="{% url 'AccountsApp:login' %}" style='text-decoration:none'>Login</a> your account!
                            </h3>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Existing timer code

        const songPreviewElement = document.getElementById('song-preview');
        const songGuessElement = document.getElementById('song-guess');
        const submitAnswerButton = document.getElementById('submit-answer');
        let correctSongName;

        function startQuiz() {
            // Fetch song and start timer
            fetchSongAndStartTimer();
        }

        let countdown = 30;
        let timerElement = document.getElementById('timer')

        function updateTimerDisplay() {
            timerElement.textContent = `Time remaining: ${countdown} seconds`;

            if (countdown <= 0) {
                skipSong();
            }
        }

        function startTimer() {
            updateTimerDisplay()
            countdown--
            if (countdown >= 0) {
                setTimeout(startTimer, 1000)
            }
        }

        function skipSong() {
            const resultMessageElement = document.getElementById('result-message')
            const resultMessageTextElement = document.getElementById('result-message-text')

            resultMessageTextElement.textContent = `Time's up`
            resultMessageElement.classList.add('alert-danger')
            resultMessageElement.classList.remove('d-none')

            songPreviewElement.pause()

            setTimeout(() => {
                location.reload()
            }, 3000) // Delay for 3 seconds
        }


        function fetchSongAndStartTimer() {
            fetch('/quiz/api/get_random_song/')
                .then(response => response.json())
                .then(data => {
                    const songPreviewURL = data.song_preview_url;
                    correctSongName = data.correct_song_name;
        
                    console.log(`Song Preview URL: ${songPreviewURL}`);
                    console.log(`Correct Song Name: ${correctSongName}`);
        
                    songPreviewElement.src = songPreviewURL;
                    songPreviewElement.volume = 0.1;
                    songPreviewElement.play(); // Start playing the audio
                    startTimer();
                })
                .catch(error => {
                    console.error('Error fetching song:', error);
                });
        }

        startQuiz();

        // Submit user's answer
        submitAnswerButton.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent the default form submission
            const userGuess = songGuessElement.value.trim();
            if (userGuess) {
                submitUserGuess(userGuess);
            }
        });      

        function submitUserGuess(guess) {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        
            fetch('/quiz/api/submit_guess/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ guess: guess, correct_song_name: correctSongName }),
            })
            .then(response => response.json())
            .then(data => {
                const resultMessageElement = document.getElementById('result-message');
            const resultMessageTextElement = document.getElementById('result-message-text');
            if (data.message === 'Correct guess!') {
                resultMessageTextElement.textContent = 'Congratulations! Your guess is correct!';
                resultMessageElement.classList.remove('d-none');
                resultMessageElement.classList.remove('alert-danger'); // Remove red styling if previous answer was incorrect
            } else {
                resultMessageTextElement.textContent = 'Oops! Your guess is incorrect.';
                resultMessageElement.classList.remove('d-none');
                resultMessageElement.classList.add('alert-danger'); // Add red styling for incorrect answer
            }
        
                // Delay for a few seconds before reloading the form
                setTimeout(() => {
                    location.reload();
                }, 3000); // Delay for 3 seconds
            })
            .catch(error => {
                console.error('Error submitting guess:', error);
            });
        }

    </script>

{% endblock %} 