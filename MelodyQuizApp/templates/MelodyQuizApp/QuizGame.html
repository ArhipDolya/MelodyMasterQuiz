{% extends 'base.html' %}

{% block title %}
    <title>QuizGame</title>
{% endblock %}

{% block content %}
    <h1>Game Page</h1>

    {% if user.is_authenticated %}
        {% if not user.socialaccount_set.all %}
            <form id="guess-form">
                {% csrf_token %}

                <audio controls id="song-preview">
                    <source src="" type="audio/mpeg">
                    Your browser does not support the audio element.
                </audio>
                <input type="text" id="song-guess" placeholder="Enter the song name">
                <button id="submit-answer">Submit Answer</button>
                <div id="result-message"></div>
            </form>
        {% endif %}
    {% endif %}

    {% if not user.is_authenticated %}
        <h1>To get this functionality you firstly need to 
            <a href="{% url 'AccountsApp:register' %}">Register</a> your account
        </h1>
    {% endif %}

    <script>
        // Existing timer code

        const songPreviewElement = document.getElementById('song-preview');
        const songGuessElement = document.getElementById('song-guess');
        const submitAnswerButton = document.getElementById('submit-answer');
        let correctSongName;

        function startQuiz() {
            // Fetch song and start timer
            fetchSongAndStartTimer();
        }

        function fetchSongAndStartTimer() {
            fetch('/quiz/api/get_random_song/')  // Update the API endpoint
                .then(response => response.json())
                .then(data => {
                    const songPreviewURL = data.song_preview_url;
                    correctSongName = data.correct_song_name;
        
                    console.log(`Song Preview URL: ${songPreviewURL}`);
                    console.log(`Correct Song Name: ${correctSongName}`);
        
                    songPreviewElement.src = songPreviewURL;
                    songPreviewElement.volume = 0.1;
                    songPreviewElement.play(); // Start playing the audio
                    startTimer();
                })
                .catch(error => {
                    console.error('Error fetching song:', error);
                });
        }

        startQuiz();

        // Submit user's answer
        submitAnswerButton.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent the default form submission
            const userGuess = songGuessElement.value.trim();
            if (userGuess) {
                submitUserGuess(userGuess);
            }
        });      

        function submitUserGuess(guess) {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
        
            fetch('/quiz/api/submit_guess/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ guess: guess, correct_song_name: correctSongName }),
            })
            .then(response => response.json())
            .then(data => {
                const resultMessageElement = document.getElementById('result-message');
                if (data.message === 'Correct guess!') {
                    resultMessageElement.textContent = 'Congratulations! Your guess is correct!';
                } else {
                    resultMessageElement.textContent = 'Oops! Your guess is incorrect.';
                }
        
                // Delay for a few seconds before reloading the form
                setTimeout(() => {
                    location.reload();
                }, 5000); // Delay for 5 seconds
            })
            .catch(error => {
                console.error('Error submitting guess:', error);
            });
        }

    </script>

{% endblock %} 