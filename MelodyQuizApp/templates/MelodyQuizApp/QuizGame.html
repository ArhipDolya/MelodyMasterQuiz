{% extends 'base.html' %}

{% block title %}
    <title>QuizGame</title>
{% endblock %}

{% block content %}
    <h1>Game Page</h1>

    <form id="guess-form">
        {% csrf_token %}

        <audio controls id="song-preview">
            <source src="" type="audio/mpeg">
            Your browser does not support the audio element.
        </audio>
        <input type="text" id="song-guess" placeholder="Enter the song name">
        <button id="submit-answer">Submit Answer</button>
    </form> 

    <script>
        // Existing timer code

        const songPreviewElement = document.getElementById('song-preview');
        const songGuessElement = document.getElementById('song-guess');
        const submitAnswerButton = document.getElementById('submit-answer');

        function startQuiz() {
            // Fetch song and start timer
            fetchSongAndStartTimer();
        }

        function fetchSongAndStartTimer() {
            fetch('/quiz/api/get_random_song/')  // Update the API endpoint
                .then(response => response.json())
                .then(data => {
                    const songPreviewURL = data.song_preview_url;
                    songPreviewElement.src = songPreviewURL;
                    songPreviewElement.volume = 0.1;
                    songPreviewElement.play(); // Start playing the audio
                    startTimer();
                })
                .catch(error => {
                    console.error('Error fetching song:', error);
                });
        }

        startQuiz();

        // Submit user's answer
        submitAnswerButton.addEventListener('click', () => {
            const userGuess = songGuessElement.value.trim();
            if (userGuess) {
                submitUserGuess(userGuess);
            }
        });

        function submitUserGuess(guess) {
            const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;

            fetch('/quiz/api/submit_guess/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                },
                body: JSON.stringify({ guess: guess }),
            })
                .then(response => response.json())
                .then(data => {
                    // Handle response data, update score, etc.
                    console.log(data);
                })
                .catch(error => {
                    console.error('Error submitting guess:', error);
                });
        }

    </script>

{% endblock %} 